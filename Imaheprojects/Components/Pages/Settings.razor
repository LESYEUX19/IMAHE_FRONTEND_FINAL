@page "/settings"
@using System.Text
@using System.Text.Json
@using System.Text.Json.Serialization
@inject HttpClient Http
@inject IJSRuntime JSRuntime

<PageTitle>Settings</PageTitle>

<div class="settings-page-wrapper">
    <div class="settings-container">
        <div class="header-section">
            <span class="oi oi-cog header-icon"></span>
            <div>
                <h1>Classification Settings</h1>
                <p class="lead">Fine-tune the AI's sensitivity to get the perfect sorting results for your photos.</p>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger" role="alert">@errorMessage</div>
        }

        @if (settingsModel == null)
        {
            <div class="text-center mt-5"><div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div><p class="mt-2"><em>Loading your settings...</em></p></div>
        }
        else
        {
            <div class="settings-grid">
                <div class="settings-card">
                    <div class="card-header"><span class="oi oi-image me-2"></span>Image Quality</div>
                    <div class="card-body">
                        <div class="setting-item">
                            <div class="icon-wrapper"><span class="oi oi-moon"></span></div>
                            <div>
                                <label for="minExposure" class="form-label">Minimum Exposure</label>
                                <input id="minExposure" type="number" class="form-control" @bind="settingsModel.MinExposure" />
                                <div class="form-text">Flags photos that are too dark. <strong>Recommended: 50</strong></div>
                            </div>
                        </div>
                        <div class="setting-item">
                            <div class="icon-wrapper"><span class="oi oi-sun"></span></div>
                            <div>
                                <label for="maxExposure" class="form-label">Maximum Exposure</label>
                                <input id="maxExposure" type="number" class="form-control" @bind="settingsModel.MaxExposure" />
                                <div class="form-text">Flags photos that are too bright. <strong>Recommended: 200</strong></div>
                            </div>
                        </div>
                        <div class="setting-item">
                            <div class="icon-wrapper"><span class="oi oi-magnifying-glass"></span></div>
                            <div>
                                <label for="minSharpness" class="form-label">Minimum Sharpness</label>
                                <input id="minSharpness" type="number" class="form-control" @bind="settingsModel.MinSharpness" />
                                <div class="form-text">Flags photos where the main subject is blurry. <strong>Recommended: 100</strong></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-card">
                    <div class="card-header"><span class="oi oi-people me-2"></span>Face & Focus Analysis</div>
                    <div class="card-body">
                        <div class="setting-item">
                            <div class="icon-wrapper"><span class="oi oi-star"></span></div>
                            <div>
                                <label for="verySharpThreshold" class="form-label">"Very Sharp" Threshold</label>
                                <input id="verySharpThreshold" type="number" class="form-control" @bind="settingsModel.VerySharpThreshold" />
                                <div class="form-text">A subject must be sharper than this to be "Focused". <strong>Recommended: 250</strong></div>
                            </div>
                        </div>
                        <div class="setting-item">
                            <div class="icon-wrapper"><span class="oi oi-fullscreen-exit"></span></div>
                            <div>
                                <label for="focusedRatio" class="form-label">Focus Ratio</label>
                                <input id="focusedRatio" type="number" step="0.1" class="form-control" @bind="settingsModel.FocusedRatio" />
                                <div class="form-text">How much sharper a subject must be than the background. <strong>Recommended: 1.75</strong></div>
                            </div>
                        </div>
                        <div class="setting-item">
                            <div class="icon-wrapper"><span class="oi oi-eye"></span></div>
                            <div>
                                <label for="closedEyePercentage" class="form-label">Closed Eye Tolerance</label>
                                <input id="closedEyePercentage" type="number" step="0.1" max="1" min="0" class="form-control" @bind="settingsModel.ClosedEyePercentage" />
                                <div class="form-text">Flags photos if this percentage of people are blinking (0.5 = 50%). <strong>Recommended: 0.5</strong></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="settings-card summary-card">
                <div class="card-header"><span class="oi oi-task me-2"></span>Your AI Assistant's Instructions</div>
                <div class="card-body summary-body">
                    <p>With these settings, here is my current sorting strategy:</p>
                    @GetSettingsSummary()
                </div>
                <div class="card-footer">
                    <button class="btn btn-outline-secondary me-auto" @onclick="ResetToDefault"><span class="oi oi-reload me-1"></span>Reset to Recommended</button>
                    <button class="btn btn-success" @onclick="SaveChanges" disabled="@isSaving">
                        @if (isSaving)
                        {
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                            <span class="ms-1">Saving...</span>
    }
                        else
                        {
                            <span class="oi oi-check"></span>
                            <span> Save Changes</span>
    }
                    </button>
                </div>
            </div>
        }
    </div>
</div>

<style>
    .settings-page-wrapper {
        padding: 2rem 3rem;
        background-color: #f8f9fa;
        min-height: 100%;
    }

    .settings-container {
        max-width: 900px;
        margin: auto;
    }

    .header-section {
        display: flex;
        align-items: center;
        margin-bottom: 0.5rem;
        gap: 1rem;
    }

    .header-icon {
        font-size: 2.5rem;
        color: #495057;
    }

    .settings-container h1 {
        margin-bottom: 0;
    }

    .settings-container .lead {
        color: #6c757d;
        margin-top: 0;
        margin-bottom: 2.5rem;
    }

    .settings-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
    }

    .settings-card {
        background-color: #ffffff;
        border: 1px solid #dee2e6;
        border-radius: 0.75rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        display: flex;
        flex-direction: column;
    }

    .card-header {
        font-weight: 600;
        font-size: 1.1rem;
        padding: 1rem 1.5rem;
        background-color: #fdfdff;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        align-items: center;
    }

    .card-body {
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1.75rem;
    }

    .card-footer {
        margin-top: auto;
        padding: 1rem 1.5rem;
        background-color: #f8f9fa;
        border-top: 1px solid #dee2e6;
        display: flex;
        justify-content: flex-end;
    }

    .setting-item {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
    }

    .icon-wrapper {
        flex-shrink: 0;
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #e9ecef;
    }

        .icon-wrapper .oi {
            font-size: 1.25rem;
            color: #495057;
        }

    .setting-item > div {
        flex-grow: 1;
    }

    .setting-item .form-label {
        font-weight: 500;
        margin-bottom: 0.25rem;
    }

    .summary-card {
        grid-column: 1 / -1;
    }

    .summary-body ul {
        list-style-type: none;
        padding-left: 0;
        margin-bottom: 0;
    }

    .summary-body li {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        padding: 0.75rem 0;
    }

        .summary-body li:not(:last-child) {
            border-bottom: 1px solid #f0f0f0;
        }

    .summary-body .oi {
        font-size: 1.1rem;
        margin-top: 0.2rem;
    }

    .rec-level {
        font-size: 0.75rem;
        font-weight: 600;
        padding: 0.2rem 0.5rem;
        border-radius: 1rem;
        color: #495057;
    }

    .rec-balanced {
        background-color: #d1e7dd;
        color: #0f5132;
    }

    .rec-relaxed {
        background-color: #cce5ff;
        color: #052c65;
    }

    .rec-strict {
        background-color: #f8d7da;
        color: #58151c;
    }

    @@media (max-width: 768px) {
        .settings-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

@code {
    private SettingsModel? settingsModel;
    private string? errorMessage;
    private bool isSaving = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadSettings();
    }

    private async Task LoadSettings()
    {
        try
        {
            settingsModel = await Http.GetFromJsonAsync<SettingsModel>("http://localhost:8000/settings");
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load settings: {ex.Message}";
        }
    }

    private async Task SaveChanges()
    {
        if (settingsModel == null) return;
        isSaving = true;
        errorMessage = null;
        try
        {
            // We need to send ALL the properties back to the backend, including the float values
            var response = await Http.PostAsJsonAsync("http://localhost:8000/settings", settingsModel);
            if (response.IsSuccessStatusCode)
            {
                await JSRuntime.InvokeVoidAsync("alert", "Settings saved successfully!");
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                errorMessage = $"Failed to save settings: {errorContent}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task ResetToDefault()
    {
        bool confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to reset all settings to their recommended defaults?");
        if (confirmed && settingsModel != null)
        {
            // Reset to hardcoded recommended defaults (matching DEFAULT_SETTINGS in main.py)
            settingsModel = new SettingsModel
            {
                MinExposure = 50,
                MaxExposure = 200,
                MinSharpness = 100,
                VerySharpThreshold = 250,
                FocusedRatio = 1.75f,
                ClosedEyePercentage = 0.5f,
                EyeAspectRatio = 0.25f
            };
            await SaveChanges();
        }
    }

    private MarkupString GetSettingsSummary()
    {
        if (settingsModel == null) return new MarkupString("");

        var summary = new StringBuilder("<ul>");

        // Fixed the summary items to correctly reference the settings model properties
        summary.Append($"<li><span class='oi oi-ban text-danger'></span><div>I will flag photos that are too dark (below <strong>{settingsModel.MinExposure:F0}</strong>) or too bright (above <strong>{settingsModel.MaxExposure:F0}</strong>).</div></li>");
        summary.Append($"<li><span class='oi oi-ban text-danger'></span><div>I will flag a photo as 'Blurred' if its sharpest subject is below <strong>{settingsModel.MinSharpness:F0}</strong>.</div></li>");
        summary.Append($"<li><span class='oi oi-thumb-up text-success'></span><div>I will look for 'Focused' shots where the subject is sharper than <strong>{settingsModel.VerySharpThreshold:F0}</strong> and <strong>{settingsModel.FocusedRatio:F2}x</strong> sharper than the background.</div></li>");
        summary.Append($"<li><span class='oi oi-ban text-danger'></span><div>I will flag a group photo if <strong>{(settingsModel.ClosedEyePercentage * 100):F0}%</strong> or more of the people are blinking.</div></li>");

        summary.Append("</ul>");
        return new MarkupString(summary.ToString());
    }

    // --- C# Models to match the Backend (main.py) ---
    public class SettingsModel
    {
        [JsonPropertyName("min_exposure")] public float MinExposure { get; set; }
        [JsonPropertyName("max_exposure")] public float MaxExposure { get; set; }
        [JsonPropertyName("min_sharpness")] public float MinSharpness { get; set; }
        [JsonPropertyName("focused_ratio")] public float FocusedRatio { get; set; }
        [JsonPropertyName("very_sharp_threshold")] public float VerySharpThreshold { get; set; }
        [JsonPropertyName("eye_aspect_ratio")] public float EyeAspectRatio { get; set; }
        [JsonPropertyName("closed_eye_percentage")] public float ClosedEyePercentage { get; set; }
    }
}